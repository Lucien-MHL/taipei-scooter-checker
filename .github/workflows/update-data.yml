# é€™å€‹æª”æ¡ˆçš„åå­—ï¼Œæœƒé¡¯ç¤ºåœ¨ GitHub Actions é é¢
name: Monthly Data Update

# ä»€éº¼æ™‚å€™åŸ·è¡Œé€™å€‹ workflow
on:
  # cron: æ¯æœˆ 1 è™Ÿæ—©ä¸Š 9 é»ž (å°ç£æ™‚é–“ = UTC+8ï¼Œæ‰€ä»¥ UTC 1 é»ž)
  schedule:
    - cron: '0 1 1 * *'  # åˆ† æ™‚ æ—¥ æœˆ é€±ï¼Œ* è¡¨ç¤ºæ¯å€‹æœˆ

  # ä¹Ÿå¯ä»¥æ‰‹å‹•è§¸ç™¼ (åœ¨ GitHub ç¶²é ä¸Šé»žæŒ‰éˆ•)
  workflow_dispatch:

# é€™å€‹ workflow éœ€è¦ä»€éº¼æ¬Šé™
permissions:
  contents: write  # éœ€è¦å¯«æ¬Šé™æ‰èƒ½ commit æª”æ¡ˆ
  issues: write    # éœ€è¦æ¬Šé™æ‰èƒ½å»ºç«‹ Issue
  actions: write   # éœ€è¦æ¬Šé™æ‰èƒ½è§¸ç™¼å…¶ä»– workflows

# è¦åšçš„å·¥ä½œ
jobs:
  update-stations-data:
    # åœ¨ Ubuntu è™›æ“¬æ©Ÿä¸ŠåŸ·è¡Œ
    runs-on: ubuntu-latest

    steps:
      # æ­¥é©Ÿ 1: ä¸‹è¼‰ä½ çš„ç¨‹å¼ç¢¼
      - name: ðŸ“¥ ä¸‹è¼‰ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 2: å®‰è£ Node.js
      - name: ðŸš€ å®‰è£ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # æ­¥é©Ÿ 3: å®‰è£ç›¸ä¾å¥—ä»¶
      - name: ðŸ“¦ å®‰è£å¥—ä»¶
        run: npm ci

      # æ­¥é©Ÿ 4: åŸ·è¡Œä½ çš„è³‡æ–™æ›´æ–°è…³æœ¬
      - name: ðŸ”„ åŸ·è¡Œè³‡æ–™æ›´æ–°
        run: node scripts/index.js

      # æ­¥é©Ÿ 5: æª¢æŸ¥å¤±æ•—ç«™é»žä¸¦å»ºç«‹ Issue
      - name: ðŸ“‹ è™•ç†å¤±æ•—ç«™é»ž Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æª¢æŸ¥æ˜¯å¦æœ‰å¤±æ•—çš„ç«™é»ž (coordinates: null)
          FAILED_COUNT=$(node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('public/data/stations.json', 'utf8'));
            const failed = data.stations.filter(s => !s.coordinates);
            console.log(failed.length);
          ")

          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "ç™¼ç¾ $FAILED_COUNT å€‹å¤±æ•—ç«™é»žï¼Œå»ºç«‹ Issue..."

            # å»ºç«‹ Issue çš„å…§å®¹
            node -e "
              const fs = require('fs');
              const data = JSON.parse(fs.readFileSync('public/data/stations.json', 'utf8'));
              const failed = data.stations.filter(s => !s.coordinates);

              let issueBody = '## ðŸ“ éœ€è¦æ‰‹å‹•è™•ç†åº§æ¨™çš„æª¢é©—ç«™\\n\\n';
              issueBody += 'ä»¥ä¸‹ç«™é»žç„¡æ³•è‡ªå‹•å–å¾—ç²¾ç¢ºåº§æ¨™ï¼Œéœ€è¦æ‰‹å‹•æŸ¥è©¢ï¼š\\n\\n';

              failed.forEach((station, index) => {
                const encodedAddr = encodeURIComponent(station.address);
                const tgosUrl = \`https://map.tgos.tw/TGOSCloudMap?addr=\${encodedAddr}\`;

                issueBody += \`### \${index + 1}. \${station.name}\\n\`;
                issueBody += \`- **ID**: \${station.id}\\n\`;
                issueBody += \`- **åœ°å€**: \${station.address}\\n\`;
                issueBody += \`- **é›»è©±**: \${station.phone}\\n\`;
                issueBody += \`- **è² è²¬äºº**: \${station.owner}\\n\`;
                issueBody += \`- ðŸ—ºï¸ **[æŸ¥çœ‹ TGOS åœ°åœ–](\${tgosUrl})**\\n\\n\`;
              });

              issueBody += '## ðŸ“ è™•ç†èªªæ˜Ž\\n\\n';
              issueBody += '1. é»žæ“Šä¸Šæ–¹ TGOS åœ°åœ–é€£çµ\\n';
              issueBody += '2. ç¢ºèªåœ°å€ä½ç½®ä¸¦å–å¾—ç²¾ç¢ºåº§æ¨™\\n';
              issueBody += '3. åœ¨æ­¤ Issue ä¸‹æ–¹ç•™è¨€ï¼Œæ ¼å¼ï¼š\\n';
              issueBody += '   \\\`\\\`\\\`\\n';
              issueBody += '   ID: ç«™é»žID\\n';
              issueBody += '   åæ¨™: ç·¯åº¦,ç¶“åº¦\\n';
              issueBody += '   \\\`\\\`\\\`\\n';
              issueBody += '4. ç³»çµ±æœƒè‡ªå‹•è™•ç†ä¸¦æ›´æ–°è³‡æ–™\\n\\n';
              issueBody += '> æ­¤ Issue ç”±ç³»çµ±è‡ªå‹•å»ºç«‹æ–¼ ' + new Date().toISOString().split('T')[0];

              fs.writeFileSync('issue_body.txt', issueBody);
            "

            # å…ˆå»ºç«‹å¿…è¦çš„æ¨™ç±¤ (å¦‚æžœä¸å­˜åœ¨çš„è©±)
            gh label create "åº§æ¨™è™•ç†" --color "d73a4a" --description "éœ€è¦æ‰‹å‹•è™•ç†åº§æ¨™çš„ç«™é»ž" || true
            gh label create "è‡ªå‹•åŒ–" --color "0075ca" --description "è‡ªå‹•åŒ–ç³»çµ±ç›¸é—œ" || true

            # ä½¿ç”¨ GitHub CLI å»ºç«‹ Issue
            ISSUE_TITLE="ðŸ”§ åº§æ¨™è™•ç†éœ€æ±‚ - $(date +%Yå¹´%mæœˆ)"
            gh issue create \
              --title "$ISSUE_TITLE" \
              --body-file issue_body.txt \
              --label "åº§æ¨™è™•ç†,è‡ªå‹•åŒ–"

            rm issue_body.txt
          else
            echo "æ²’æœ‰å¤±æ•—ç«™é»žï¼Œè·³éŽ Issue å»ºç«‹"
          fi

      # æ­¥é©Ÿ 6: å¦‚æžœæœ‰è®Šæ›´å°± commit
      - name: ðŸ’¾ æäº¤æ›´æ–°çš„è³‡æ–™
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          if [[ -n $(git status --porcelain) ]]; then
            git add public/data/stations.json
            git commit -m "chore: auto-update station data $(date +%Y-%m-%d)"
            git push
            echo "âœ… è³‡æ–™å·²æäº¤ï¼Œæº–å‚™è§¸ç™¼éƒ¨ç½²..."
            echo "DATA_UPDATED=true" >> $GITHUB_ENV
          else
            echo "æ²’æœ‰è³‡æ–™è®Šæ›´ï¼Œè·³éŽ commit"
            echo "DATA_UPDATED=false" >> $GITHUB_ENV
          fi

      # æ­¥é©Ÿ 7: è§¸ç™¼ GitHub Pages éƒ¨ç½²
      - name: ðŸš€ è§¸ç™¼ GitHub Pages éƒ¨ç½²
        if: env.DATA_UPDATED == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "è³‡æ–™å·²æ›´æ–°ï¼Œè§¸ç™¼ Deploy workflow..."
          gh workflow run deploy.yml
          echo "âœ… Deploy workflow å·²è§¸ç™¼"