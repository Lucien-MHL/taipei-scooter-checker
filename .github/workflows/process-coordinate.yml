# ç›£è½ Issue Commentï¼Œè‡ªå‹•è™•ç†åº§æ¨™æ›´æ–°
name: Process Manual Coordinates

# ç•¶æœ‰äººåœ¨ Issue ç•™è¨€æ™‚è§¸ç™¼
on:
  issue_comment:
    types: [created]

# éœ€è¦æ¬Šé™
permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  process-coordinates:
    # åªè™•ç†åŒ…å«ç‰¹å®šæ¨™ç±¤çš„ Issue çš„ç•™è¨€
    if: contains(github.event.issue.labels.*.name, 'åº§æ¨™è™•ç†')
    runs-on: ubuntu-latest

    steps:
      # æ­¥é©Ÿ 1: å¿«é€Ÿæ ¼å¼æª¢æŸ¥ (çœæ™‚çœè³‡æº)
      - name: ğŸ” å¿«é€Ÿæª¢æŸ¥ç•™è¨€æ ¼å¼
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
        run: |
          echo "æª¢æŸ¥ç•™è¨€æ ¼å¼..."
          echo "ç•™è¨€å…§å®¹: $COMMENT_BODY"

          # æª¢æŸ¥ ID æ ¼å¼: "ID: AI6" æˆ– "ID:AI6"
          if [[ ! "$COMMENT_BODY" =~ ID:[[:space:]]*[A-Z0-9]+ ]]; then
            echo "âŒ æ‰¾ä¸åˆ°æ­£ç¢ºçš„ ID æ ¼å¼"
            echo "éœ€è¦æ ¼å¼: ID: ç«™é»ID"
            echo "ç¯„ä¾‹: ID: AI6"
            exit 1
          fi

          # æª¢æŸ¥åº§æ¨™æ ¼å¼: "åæ¨™: 25.123,121.456" æˆ– "åæ¨™:25.123, 121.456"
          if [[ ! "$COMMENT_BODY" =~ åæ¨™:[[:space:]]*[0-9.]+,[[:space:]]*[0-9.]+ ]]; then
            echo "âŒ æ‰¾ä¸åˆ°æ­£ç¢ºçš„åº§æ¨™æ ¼å¼"
            echo "éœ€è¦æ ¼å¼: åæ¨™: ç·¯åº¦,ç¶“åº¦"
            echo "ç¯„ä¾‹: åæ¨™: 25.0387951,121.5639969"
            exit 1
          fi

          echo "âœ… æ ¼å¼æª¢æŸ¥é€šéï¼Œç¹¼çºŒè™•ç†..."

      # æ­¥é©Ÿ 2: ä¸‹è¼‰ç¨‹å¼ç¢¼ (åªåœ¨æ ¼å¼æ­£ç¢ºæ™‚åŸ·è¡Œ)
      - name: ğŸ“¥ ä¸‹è¼‰ç¨‹å¼ç¢¼
        uses: actions/checkout@v4

      # æ­¥é©Ÿ 3: å®‰è£ Node.js
      - name: ğŸš€ å®‰è£ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # æ­¥é©Ÿ 4: å®‰è£å¥—ä»¶
      - name: ğŸ“¦ å®‰è£å¥—ä»¶
        run: npm ci

      # æ­¥é©Ÿ 5: è§£æç•™è¨€ä¸¦æ›´æ–°åº§æ¨™
      - name: ğŸ” è™•ç†åº§æ¨™ç•™è¨€
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "è™•ç† Issue #$ISSUE_NUMBER çš„ç•™è¨€..."

          # å»ºç«‹åº§æ¨™è™•ç†è…³æœ¬
          cat > process_comment.js << 'EOF'
          const fs = require('fs');

          // å–å¾—ç•™è¨€å…§å®¹
          const commentBody = process.env.COMMENT_BODY;
          console.log('ç•™è¨€å…§å®¹:', commentBody);

          // è§£æåº§æ¨™æ ¼å¼ "ID: AI6\nåæ¨™: 25.123,121.456"
          const idMatch = commentBody.match(/ID:\s*([A-Z0-9]+)/i);
          const coordMatch = commentBody.match(/åæ¨™:\s*([0-9.]+),\s*([0-9.]+)/);

          if (!idMatch || !coordMatch) {
            console.log('âŒ ç•™è¨€æ ¼å¼ä¸æ­£ç¢ºï¼Œéœ€è¦æ ¼å¼ï¼šID: ç«™é»ID\\nåæ¨™: ç·¯åº¦,ç¶“åº¦');
            process.exit(1);
          }

          const stationId = idMatch[1];
          const lat = parseFloat(coordMatch[1]);
          const lng = parseFloat(coordMatch[2]);

          console.log(`âœ… è§£ææˆåŠŸ: ${stationId} -> (${lat}, ${lng})`);

          // è®€å–ç¾æœ‰è³‡æ–™
          const dataPath = 'public/data/stations.json';
          const data = JSON.parse(fs.readFileSync(dataPath, 'utf8'));

          // æ‰¾åˆ°å°æ‡‰ç«™é»ä¸¦æ›´æ–°
          let updated = false;
          for (let station of data.stations) {
            if (station.id === stationId) {
              station.coordinates = { lat, lng };
              station.geocoding = {
                source: 'manual_tgos',
                accuracy: 'high',
                geocoded_at: new Date().toISOString()
              };
              updated = true;
              console.log(`âœ… å·²æ›´æ–°ç«™é»: ${station.name} (${station.id})`);
              break;
            }
          }

          if (!updated) {
            console.log(`âŒ æ‰¾ä¸åˆ° ID ç‚º ${stationId} çš„ç«™é»`);
            process.exit(1);
          }

          // å„²å­˜æ›´æ–°å¾Œçš„è³‡æ–™
          fs.writeFileSync(dataPath, JSON.stringify(data, null, 2), 'utf8');
          console.log('âœ… è³‡æ–™å·²æ›´æ–°ä¸¦å„²å­˜');

          // è¼¸å‡ºçµæœä¾›å¾ŒçºŒæ­¥é©Ÿä½¿ç”¨
          console.log(`UPDATED_STATION=${stationId}`);
          console.log(`STATION_NAME=${data.stations.find(s => s.id === stationId).name}`);
          EOF

          # åŸ·è¡Œåº§æ¨™è™•ç†è…³æœ¬
          node process_comment.js

      # æ­¥é©Ÿ 6: æäº¤æ›´æ–°çš„è³‡æ–™
      - name: ğŸ’¾ æäº¤åº§æ¨™æ›´æ–°
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

          if [[ -n $(git status --porcelain) ]]; then
            git add public/data/stations.json
            git commit -m "chore: update manual coordinates via issue comment"
            git push
            echo "âœ… åº§æ¨™æ›´æ–°å·²æäº¤"
          else
            echo "æ²’æœ‰è®Šæ›´éœ€è¦æäº¤"
          fi

      # æ­¥é©Ÿ 7: å›è¦†ç•™è¨€ç¢ºèªè™•ç†çµæœ
      - name: ğŸ’¬ å›è¦†è™•ç†çµæœ
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å»ºç«‹å›è¦†å…§å®¹
          cat > reply.txt << 'EOF'
          âœ… **åº§æ¨™æ›´æ–°æˆåŠŸï¼**

          å·²æˆåŠŸè™•ç†æ‚¨æä¾›çš„åº§æ¨™è³‡è¨Šï¼š
          - **ç«™é» ID**: ${{ env.UPDATED_STATION }}
          - **åº§æ¨™ä¾†æº**: æ‰‹å‹• TGOS æŸ¥è©¢
          - **è™•ç†æ™‚é–“**: $(date '+%Y-%m-%d %H:%M:%S')

          è³‡æ–™å·²è‡ªå‹•æ›´æ–°ä¸¦éƒ¨ç½²ã€‚æ„Ÿè¬æ‚¨çš„å”åŠ©ï¼ ğŸ™

          > æ­¤å›è¦†ç”±è‡ªå‹•åŒ–ç³»çµ±ç”¢ç”Ÿ
          EOF

          # ä½¿ç”¨ GitHub CLI å›è¦†ç•™è¨€
          gh issue comment ${{ github.event.issue.number }} --body-file reply.txt

      # æ­¥é©Ÿ 8: æª¢æŸ¥æ˜¯å¦æ‰€æœ‰å¤±æ•—ç«™é»éƒ½å·²è™•ç†å®Œç•¢
      - name: ğŸ” æª¢æŸ¥è™•ç†é€²åº¦ä¸¦é—œé–‰ Issue
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # æª¢æŸ¥é‚„æœ‰å¤šå°‘å€‹å¤±æ•—ç«™é»
          REMAINING_COUNT=$(node -e "
            const fs = require('fs');
            const data = JSON.parse(fs.readFileSync('public/data/stations.json', 'utf8'));
            const failed = data.stations.filter(s => !s.coordinates);
            console.log(failed.length);
          ")

          if [ "$REMAINING_COUNT" -eq 0 ]; then
            echo "ğŸ‰ æ‰€æœ‰ç«™é»éƒ½å·²è™•ç†å®Œç•¢ï¼Œé—œé–‰ Issue"
            gh issue close ${{ github.event.issue.number }} --comment "ğŸ‰ **æ‰€æœ‰åº§æ¨™å·²è™•ç†å®Œç•¢**

          æ„Ÿè¬å”åŠ©ï¼æ‰€æœ‰æª¢é©—ç«™çš„åº§æ¨™éƒ½å·²æˆåŠŸæ›´æ–°ã€‚

          ğŸ“Š **è™•ç†çµæœçµ±è¨ˆ**:
          - âœ… ç¸½ç«™é»æ•¸: 247 å€‹
          - ğŸ¯ æˆåŠŸç‡: 100%
          - ğŸ—ºï¸ åº§æ¨™ä¾†æº: Nominatim API + æ‰‹å‹• TGOS æŸ¥è©¢

          > Issue è‡ªå‹•é—œé–‰æ–¼ $(date '+%Y-%m-%d %H:%M:%S')"
          else
            echo "é‚„æœ‰ $REMAINING_COUNT å€‹ç«™é»æœªè™•ç†ï¼ŒIssue ä¿æŒé–‹æ”¾"
          fi